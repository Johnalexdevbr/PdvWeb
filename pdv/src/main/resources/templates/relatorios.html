<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV | Relat√≥rios Avan√ßados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card { border-radius: 15px; border: none; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .bg-gradient-primary { background: linear-gradient(45deg, #4f46e5, #3b82f6); }
        .bg-gradient-success { background: linear-gradient(45deg, #10b981, #059669); }
        .bg-gradient-danger { background: linear-gradient(45deg, #ef4444, #dc2626); }
        .chart-container { position: relative; height: 320px; width: 100%; }
        .badge-payment { font-size: 0.75rem; padding: 0.5em 0.8em; border-radius: 8px; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <h1 class="fw-bold text-dark m-0">üìä Dashboard de Performance</h1>
        <a href="/home" class="btn btn-outline-dark rounded-pill px-4"><i class="fas fa-home me-2"></i> In√≠cio</a>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card bg-gradient-primary text-white shadow-sm">
                <div class="card-body p-4 text-center">
                    <h6 class="text-uppercase opacity-75 small">Total de Pedidos</h6>
                    <h2 class="display-5 fw-bold mb-0" th:text="${vendasHoje}">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-gradient-danger text-white shadow-sm">
                <div class="card-body p-4 text-center">
                    <h6 class="text-uppercase opacity-75 small">Total em Descontos</h6>
                    <h2 class="display-5 fw-bold mb-0">R$
                        <span th:text="${totalDescontos != null} ? ${#numbers.formatDecimal(totalDescontos, 1, 2, 'COMMA')} : '0,00'">0,00</span>
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-gradient-success text-white shadow-sm">
                <div class="card-body p-4 text-center">
                    <h6 class="text-uppercase opacity-75 small">Faturamento L√≠quido</h6>
                    <h2 class="display-5 fw-bold mb-0">R$
                        <span th:text="${totalFaturado != null} ? ${#numbers.formatDecimal(totalFaturado, 1, 2, 'COMMA')} : '0,00'">0,00</span>
                    </h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-5 p-4">
        <h5 class="fw-bold mb-4 text-secondary"><i class="fas fa-chart-line me-2"></i>Curva de Faturamento</h5>
        <div class="chart-container"><canvas id="vendasChart"></canvas></div>
    </div>

    <div class="card shadow border-0">
        <div class="card-header bg-white py-3"><h5 class="fw-bold m-0">Hist√≥rico Detalhado por Item</h5></div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                <tr>
                    <th class="ps-4">Protocolo</th>
                    <th>Data e Hora</th>
                    <th>Produto</th>
                    <th class="text-center">Qtd</th>
                    <th>Pagamento</th>
                    <th class="text-end pe-4">Subtotal Item</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${listaItens}">
                    <td class="ps-4 fw-bold text-primary" th:text="'#' + ${item.venda.id}">#1</td>
                    <td th:text="${#temporals.format(item.venda.dataHora, 'dd/MM/yyyy HH:mm')}"></td>
                    <td class="fw-bold" th:text="${item.produto.nome}">Produto</td>
                    <td class="text-center" th:text="${item.quantidade}">1</td>
                    <td><span class="badge bg-light text-dark border badge-payment" th:text="${item.venda.formaPagamento}"></span></td>
                    <td class="text-end pe-4 fw-bold" th:text="'R$ ' + ${#numbers.formatDecimal(item.precoUnitario * item.quantidade, 1, 2, 'COMMA')}"></td>
                </tr>
                <tr th:if="${#lists.isEmpty(listaItens)}">
                    <td colspan="6" class="text-center py-4 text-muted">Nenhum item vendido encontrado.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /* Adicionada verifica√ß√£o para evitar erro se a lista estiver vazia */
    const listaVendas = [[${listaVendas}]] || [];

    if (listaVendas.length > 0) {
        const labels = listaVendas.map(v => {
            const d = new Date(v.dataHora);
            return d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
        });
        const valores = listaVendas.map(v => v.total || 0);

        const ctx = document.getElementById('vendasChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Venda (R$)',
                    data: valores,
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
</script>
</body>
</html>